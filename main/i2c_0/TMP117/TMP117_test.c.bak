#include <stdio.h>
#include "esp_log.h"
#include "driver/i2c_master.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"

#define TAG "TMP117_DUAL"

#define I2C_MASTER_SDA_IO   17
#define I2C_MASTER_SCL_IO   18
#define I2C_MASTER_FREQ_HZ  400000
#define TMP117_ADDR_FRONT   0x49   // 正面
#define TMP117_ADDR_BACK    0x48   // 背面
#define TMP117_TMP_REG      0x00
#define TMP117_RESOLUTION   0.0078125f

static i2c_master_bus_handle_t i2c_bus = NULL;
static i2c_master_dev_handle_t tmp117_front = NULL;
static i2c_master_dev_handle_t tmp117_back = NULL;

static esp_err_t i2c_master_init(void)
{
    // 创建I2C主总线
    i2c_master_bus_config_t bus_cfg = {
        .sda_io_num = I2C_MASTER_SDA_IO,
        .scl_io_num = I2C_MASTER_SCL_IO,
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
    };
    ESP_ERROR_CHECK(i2c_new_master_bus(&bus_cfg, &i2c_bus));

    // 创建正面 TMP117 设备
    i2c_device_config_t dev_front_cfg = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = TMP117_ADDR_FRONT,
        .scl_speed_hz = I2C_MASTER_FREQ_HZ,
    };
    ESP_ERROR_CHECK(i2c_master_bus_add_device(i2c_bus, &dev_front_cfg, &tmp117_front));

    // 创建背面 TMP117 设备
    i2c_device_config_t dev_back_cfg = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = TMP117_ADDR_BACK,
        .scl_speed_hz = I2C_MASTER_FREQ_HZ,
    };
    ESP_ERROR_CHECK(i2c_master_bus_add_device(i2c_bus, &dev_back_cfg, &tmp117_back));

    ESP_LOGI(TAG, "I2C bus and both TMP117 devices initialized.");
    return ESP_OK;
}

static esp_err_t TMP117_read_temp(i2c_master_dev_handle_t dev, float *temp)
{
    uint8_t reg = TMP117_TMP_REG;
    uint8_t data[2];

    esp_err_t ret = i2c_master_transmit_receive(dev, &reg, 1, data, 2, pdMS_TO_TICKS(100));
    if (ret != ESP_OK) return ret;

    int16_t raw = (int16_t)((data[0] << 8) | data[1]);
    *temp = raw * TMP117_RESOLUTION;
    return ESP_OK;
}

void app_main(void)
{
    ESP_ERROR_CHECK(i2c_master_init());

    gpio_config_t io_conf = {
        .intr_type = GPIO_INTR_DISABLE,
        .mode = GPIO_MODE_OUTPUT,
        .pin_bit_mask = (1ULL << GPIO_NUM_34),
        .pull_up_en = GPIO_PULLUP_DISABLE,
        .pull_down_en = GPIO_PULLDOWN_DISABLE,
    };
    gpio_config(&io_conf);

    while (1) {
        float temp_front = 0, temp_back = 0;
        esp_err_t ret1 = TMP117_read_temp(tmp117_front, &temp_front);
        esp_err_t ret2 = TMP117_read_temp(tmp117_back, &temp_back);

        if (ret1 == ESP_OK)
            ESP_LOGI(TAG, "Front TMP117 (0x48): %.3f °C", temp_front);
        else
            ESP_LOGE(TAG, "Read front failed: %s", esp_err_to_name(ret1));

        if (ret2 == ESP_OK)
            ESP_LOGI(TAG, "Back TMP117 (0x49): %.3f °C", temp_back);
        else
            ESP_LOGE(TAG, "Read back failed: %s", esp_err_to_name(ret2));

        vTaskDelay(pdMS_TO_TICKS(1000));

    }
}