// file: main/mp4245_i2c_example.c
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <math.h>
#include "driver/i2c_master.h"
#include "esp_log.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

#define TAG "MP4245"

// ------ I2C 配置 ------
#define MP4245_I2C_PORT       0
#define MP4245_I2C_SDA_GPIO   17
#define MP4245_I2C_SCL_GPIO   18
#define MP4245_I2C_ADDR       0x61
#define MP4245_I2C_FREQ       100000
#define MP4245_I2C_TIMEOUT    1000

// ------ PMBus 命令 ------
#define PMBUS_CMD_VOUT_MODE           0x20
#define PMBUS_CMD_READ_VIN            0x88      // Linear11
#define PMBUS_CMD_READ_VOUT           0x8B      // Linear16 (uses VOUT_MODE exponent)
#define PMBUS_CMD_READ_TEMPERATURE_1  0x8D      // Linear11
#define PMBUS_CMD_STATUS_INPUT        0x7C
#define PMBUS_CMD_STATUS_VOUT         0x7A
#define PMBUS_CMD_STATUS_WORD         0x79

// ------ MFR MODE_CTRL ------
#define MP4245_REG_MFR_MODE_CTRL      0xD0
// 根据 datasheet，PFMP/VM 模式相关位在 D0（OUTPUT_DISCHARGE_EN）描述下有提及
// 这里假设 D0 控制 PFMP/VM 模式开关（如需组合其它位，请替换掩码）
#define PFMP_VM_BIT_MASK              (1 << 0)

// ----- I2C 句柄 -----
static i2c_master_bus_handle_t i2c_bus_handle = NULL;
static i2c_master_dev_handle_t i2c_dev_handle = NULL;

// ---- Linear11 解码 ----
static float pmbus_linear11_decode(uint16_t raw, int n_exp_override)
{
    int16_t mant = (int16_t)(raw & 0x07FF);
    int8_t  exp  = (int8_t)((raw >> 11) & 0x1F);

    if (mant & 0x0400) mant |= ~0x07FF;
    if (exp & 0x10) exp |= ~0x1F;

    if (n_exp_override != 99) exp = (int8_t)n_exp_override;

    return (float)mant * powf(2.0f, (float)exp);
}

// ---- Linear16 解码（指数来自 VOUT_MODE）----
static float pmbus_linear16_decode(uint16_t raw, int8_t exp)
{
    return (float)raw * powf(2.0f, (float)exp);
}

// ---- I2C 初始化 ----
static esp_err_t i2c_bus_init(void)
{
    i2c_master_bus_config_t cfg = {
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .i2c_port = MP4245_I2C_PORT,
        .sda_io_num = MP4245_I2C_SDA_GPIO,
        .scl_io_num = MP4245_I2C_SCL_GPIO,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
    };
    return i2c_new_master_bus(&cfg, &i2c_bus_handle);
}

static esp_err_t mp4245_device_init(void)
{
    i2c_device_config_t dev_cfg = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = MP4245_I2C_ADDR,
        .scl_speed_hz = MP4245_I2C_FREQ,
    };
    return i2c_master_bus_add_device(i2c_bus_handle, &dev_cfg, &i2c_dev_handle);
}

// ---- 通用读写封装 ----
static esp_err_t mp4245_read_word(uint8_t cmd, uint16_t *out)
{
    uint8_t rx[2] = {0};
    esp_err_t err = i2c_master_transmit_receive(i2c_dev_handle, &cmd, 1, rx, 2, MP4245_I2C_TIMEOUT);
    if (err == ESP_OK) {
        *out = (uint16_t)((rx[1] << 8) | rx[0]); // LSB first
    }
    return err;
}

static esp_err_t mp4245_read_byte(uint8_t cmd, uint8_t *out)
{
    return i2c_master_transmit_receive(i2c_dev_handle, &cmd, 1, out, 1, MP4245_I2C_TIMEOUT);
}

static esp_err_t mp4245_write_byte(uint8_t reg, uint8_t value)
{
    uint8_t tx[2] = { reg, value };
    return i2c_master_transmit(i2c_dev_handle, tx, sizeof(tx), MP4245_I2C_TIMEOUT);
}

// ---- VOUT_MODE 读取并解析指数 ----
static esp_err_t mp4245_get_vout_exponent(int8_t *exp_out)
{
    uint8_t vout_mode = 0;
    esp_err_t err = mp4245_read_byte(PMBUS_CMD_VOUT_MODE, &vout_mode);
    if (err != ESP_OK) return err;

    int8_t exp = (int8_t)(vout_mode & 0x1F);
    if (exp & 0x10) exp |= ~0x1F;
    *exp_out = exp;
    return ESP_OK;
}

// ---- 模式切换 ----
static esp_err_t mp4245_set_mode_pfmp_vm(bool enable_pfmp_vm)
{
    uint8_t mode_ctrl = 0;
    esp_err_t err = mp4245_read_byte(MP4245_REG_MFR_MODE_CTRL, &mode_ctrl);
    if (err != ESP_OK) {
        ESP_LOGE(TAG, "Read MODE_CTRL failed: %s", esp_err_to_name(err));
        return err;
    }

    uint8_t new_mode = mode_ctrl;
    if (enable_pfmp_vm) new_mode |= PFMP_VM_BIT_MASK;
    else new_mode &= (uint8_t)(~PFMP_VM_BIT_MASK);

    if (new_mode != mode_ctrl) {
        err = mp4245_write_byte(MP4245_REG_MFR_MODE_CTRL, 0x00);
        if (err != ESP_OK) {
            ESP_LOGE(TAG, "Write MODE_CTRL failed: %s", esp_err_to_name(err));
            return err;
        }
    }
    return ESP_OK;
}

#define MP4245_REG_MFR_CURRENT_LIMIT  0xD1

static esp_err_t mp4245_set_current_limit_max(void)
{
    // 最大安全值是 0x7F (6.35A)
    uint8_t curr_lim_val = 0x7F;
    esp_err_t err = mp4245_write_byte(MP4245_REG_MFR_CURRENT_LIMIT, curr_lim_val);
    if (err != ESP_OK) {
        ESP_LOGE(TAG, "Write CURRENT_LIMIT failed: %s", esp_err_to_name(err));
        return err;
    }

    // 读回确认
    uint8_t verify = 0;
    err = mp4245_read_byte(MP4245_REG_MFR_CURRENT_LIMIT, &verify);
    if (err == ESP_OK) {
        ESP_LOGI(TAG, "CURRENT_LIMIT set to 0x%02X (%.2f A)", 
                 verify, verify * 0.05f);
    }
    return err;
}

// ---- 初始化：仅切换模式 ----
static esp_err_t mp4245_init_settings(void)
{
    // 切换模式
    bool enable_pfmp_vm = true;
    esp_err_t err = mp4245_set_mode_pfmp_vm(enable_pfmp_vm);
    if (err != ESP_OK) return err;

    // 设置电流限制为最大安全值
    return mp4245_set_current_limit_max();
}

// static void mp4245_read_status_word(void)
// {
//     uint16_t raw;
//     esp_err_t err = mp4245_read_word(PMBUS_CMD_STATUS_WORD, &raw);
//     if (err != ESP_OK) {
//         ESP_LOGE(TAG, "STATUS_WORD read failed: %s", esp_err_to_name(err));
//         return;
//     }

//     // 逐位解析
//     if (raw & (1 << 0))  ESP_LOGW(TAG, "VOUT_OV_FAULT: Output over-voltage fault");
//     if (raw & (1 << 1))  ESP_LOGW(TAG, "VOUT_UV_FAULT: Output under-voltage fault");
//     if (raw & (1 << 2))  ESP_LOGW(TAG, "OFF: Unit commanded off or fault shutdown");
//     if (raw & (1 << 3))  ESP_LOGW(TAG, "VOUT_OFF: Output commanded off");
//     if (raw & (1 << 4))  ESP_LOGW(TAG, "UNKNOWN: Uncertain CC limit or non-CC fault");
//     if (raw & (1 << 5))  ESP_LOGW(TAG, "IOUT_OC_FAULT: Output over-current fault");
//     if (raw & (1 << 6))  ESP_LOGW(TAG, "VIN_UV_FAULT: Input under-voltage fault");
//     if (raw & (1 << 7))  ESP_LOGW(TAG, "TEMPERATURE: Over-temperature fault");

//     if (raw & (1 << 8))  ESP_LOGI(TAG, "POWER_GOOD: Output voltage within regulation");
//     if (raw & (1 << 10)) ESP_LOGW(TAG, "OTHER_INDICATOR_A: Other fault occurred");
//     if (raw & (1 << 11)) ESP_LOGW(TAG, "OTHER_INDICATOR_B: Other fault occurred");
//     if (raw & (1 << 12)) ESP_LOGW(TAG, "OTHER_INDICATOR_C: Other fault occurred");

//     if (raw & (1 << 15)) ESP_LOGW(TAG, "UNKNOWN (bit15): Other fault not listed");
// }


// ---- 读取状态 ----
static void mp4245_read_all_status(void)
{
    esp_err_t err;
    uint16_t raw;
    float vin, vout, temp;

    int8_t vout_exp = 0;
    err = mp4245_get_vout_exponent(&vout_exp);
    if (err != ESP_OK) ESP_LOGE(TAG, "Read VOUT_MODE failed");

    // VIN
    err = mp4245_read_word(PMBUS_CMD_READ_VIN, &raw);
    if (err == ESP_OK) {
        vin = pmbus_linear11_decode(raw, 99);
        ESP_LOGI(TAG, "VIN=%.4f V", vin);
    }

    // VOUT
    err = mp4245_read_word(PMBUS_CMD_READ_VOUT, &raw);
    if (err == ESP_OK) {
        vout = pmbus_linear16_decode(raw, vout_exp);
        ESP_LOGI(TAG, "VOUT=%.4f V", vout);
    }

    // TEMP
    err = mp4245_read_word(PMBUS_CMD_READ_TEMPERATURE_1, &raw);
    if (err == ESP_OK) {
        temp = pmbus_linear11_decode(raw, 99);
        ESP_LOGI(TAG, "TEMP=%.2f °C", temp);
    }

    // mp4245_read_status_word();
    
}

// ---- 周期任务 ----
void mp4245_monitor_task(void *param)
{
    while (1) {
        mp4245_read_all_status();
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}

// ---- app_main ----
void app_main(void)
{
    esp_err_t err;
    ESP_LOGI(TAG, "Init I2C bus...");
    err = i2c_bus_init(); 
    ESP_ERROR_CHECK(err);

    ESP_LOGI(TAG, "Probe MP4245...");
    err = i2c_master_probe(i2c_bus_handle, MP4245_I2C_ADDR, MP4245_I2C_TIMEOUT);
    if (err != ESP_OK) {
        ESP_LOGE(TAG, "MP4245 not found at 0x%02X", MP4245_I2C_ADDR);
        vTaskDelay(pdMS_TO_TICKS(5000));
        return;
    }

    ESP_LOGI(TAG, "MP4245 found.");
    err = mp4245_device_init(); 
    ESP_ERROR_CHECK(err);

    // 初始化：切换模式
    ESP_LOGI(TAG, "Apply init settings (mode control)...");
    err = mp4245_init_settings(); 
    ESP_ERROR_CHECK(err);

    // 启动周期任务
    xTaskCreate(mp4245_monitor_task, "mp4245_monitor", 4096, NULL, 5, NULL);
}